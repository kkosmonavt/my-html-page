name: Deploy-To-Ubunty-Server
#-------try untill you succeed----------
run-name: ${{ github.actor }} is deploing new changes üöÄ

on: 
  push:
    branches: 
      - main

jobs:
  Deploy:
    runs-on: ubuntu-latest

    env:
      REMOTE_HOST: ${{ secrets.REMOTE_HOST }}   
      REMOTE_USER: ${{ secrets.REMOTE_USER }}   
      TARGET_DIR: ${{ secrets.TARGET_DIR }}     
      REMOTE_PORT: ${{ secrets.REMOTE_PORT }} 
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH key and known_hosts
        run: |
          set -e
          # –°–æ–∑–¥–∞—ë–º ~/.ssh
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ GitHub Secrets)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # –ó–∞–ø—É—Å–∫–∞–µ–º ssh-agent –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/deploy_key

          # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ SECRET –ø—É—Å—Ç
          SSH_PORT="${REMOTE_PORT}"
          if [ -z "$SSH_PORT" ]; then SSH_PORT=22; fi

          # –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Å—Ç –≤ known_hosts (–Ω–µ –±—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)
          ssh-keyscan -H -p "$SSH_PORT" "$REMOTE_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
        shell: bash

      - name: Sync files to remote server (rsync)
        run: |
          set -e
          SSH_PORT="${REMOTE_PORT}"
          if [ -z "$SSH_PORT" ]; then SSH_PORT=22; fi

          # –ü—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏–ª–∏ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω rsync'–æ–º (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤)
          echo "Deploying to $REMOTE_USER@$REMOTE_HOST:$TARGET_DIR (port $SSH_PORT)"

          # –ò—Å–∫–ª—é—á–∞–µ–º –ª–∏—à–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏/—Ñ–∞–π–ª—ã ‚Äî –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–¥ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç
          RSYNC_EXCLUDES=(
            --exclude='.git'
            --exclude='.github'
            --exclude='node_modules'
            --exclude='.env'
            --exclude='deploy_key'
          )

          # –í—ã–ø–æ–ª–Ω—è–µ–º rsync (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ, —Å–∂–∞—Ç–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∞, —É–¥–∞–ª—è–µ–º —É–¥–∞–ª—ë–Ω–Ω–æ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ)
          rsync -avz --delete -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=yes" "${RSYNC_EXCLUDES[@]}" ./ "$REMOTE_USER@$REMOTE_HOST:$TARGET_DIR"

        shell: bash







